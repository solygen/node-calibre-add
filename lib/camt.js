/* node-camt.0.0.1 (2014-05-03) https://github.com/solygen/node-camt.git */!function(){"use strict";function a(a,b){var e=[],f={comment:"#",delimiter:";",escape:'"'};d().from.path(a,f).transform(function(a){return a.map(function(a){return a.trim().replace(/\s+/g," ")})}).on("record",function(a){e.push(a)}).on("end",function(){console.log(a,":",e.length),b.call(this,{columns:e.shift(),rows:e,account:c.basename(a).split("-")[1]})}).on("error",function(a){console.log(a.message)})}var b=require("fs"),c=require("path"),d=require("csv"),e=require("lodash"),f=__dirname.replace("/src","/data-target/"),g=__dirname.replace("/src","/data-source/"),h={},i=function(a){var d=c.sep,e="",f=a.split(d);f.forEach(function(a){e=e+d+a,b.existsSync(e)||b.mkdirSync(e)})},j=function(a){var d={},g=a.rows,j=a.account||"unknown";h.columns=a.columns,h.accounts=h.accounts||{},h.accounts[j]=[],g.forEach(function(a){var b=a[2],c=b.match(/(\d+)/g),e=c[2],f=e+"-"+c[1];d[e]=d[e]||[],d[e][f]=d[e][f]||[],d[e][f].push(a)}),Object.keys(d).forEach(function(a){var g,k=[];Object.keys(d[a]).forEach(function(g){var h,l=c.join(f,j,a);if(i(l),h=l+g+".json",b.existsSync(h)){var m=b.readFileSync(h,"utf8"),n=JSON.parse(m);d[a][g]=(d[a][g]||[]).concat(n)}d[a][g]=e.uniq(d[a][g],function(a){return JSON.stringify(a)}),d[a][g].sort(function(a,b){var c=a[1].match(/(\d+)/g),d=b[1].match(/(\d+)/g);return parseInt(c[2]+c[1]+c[0],10)-parseInt(d[2]+d[1]+d[0],10)}),k=k.concat(d[a][g]),b.writeFileSync(l+c.sep+g+".json",JSON.stringify(d[a][g],void 0,2))}),g=c.join(f+j)+c.sep+(a+".json"),h.accounts[j]=h.accounts[j].concat(g),b.writeFileSync(g,JSON.stringify(k,void 0,2))}),b.writeFileSync(f+"data.json",JSON.stringify(h,void 0,2))};i(g),i(f);var k=b.readdirSync(g);k.forEach(function(b){"csv"===b.split(".")[1]&&a(g+b,j)})}();